# ==========================================================
# AegeanSea Hotel — Phase 3 Automations
# 7 property-management automations
#
# USAGE (pick one):
#
#   Option A — Separate include in configuration.yaml:
#     automation phase3: !include automations_phase3.yaml
#
#   Option B — Merge into existing automations.yaml:
#     Copy the list items below into your automations.yaml
#
# NOTE: Do NOT put this inside the packages/ folder if using
#       Option A, since packages auto-load everything.
#       Move it to /config/automations_phase3.yaml instead.
#
# TEMPLATE NOTE:
#   Room number extraction uses: trigger.entity_id.split('.')[1].split('_')[1]
#   This handles domains with underscores (input_boolean, input_select)
#   by first splitting on '.' to get the entity name, then '_' for room num.
# ==========================================================

- id: ac_window_shutoff
  alias: "Κλιματισμός / Παράθυρο"
  description: "Απενεργοποίηση AC όταν ανοίγει παράθυρο σε δωμάτιο"
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - input_boolean.room_101_window_open
        - input_boolean.room_102_window_open
        - input_boolean.room_103_window_open
        - input_boolean.room_104_window_open
        - input_boolean.room_105_window_open
        - input_boolean.room_201_window_open
        - input_boolean.room_202_window_open
        - input_boolean.room_203_window_open
        - input_boolean.room_301_window_open
        - input_boolean.room_302_window_open
      to: "on"
  action:
    - service: climate.turn_off
      target:
        entity_id: "climate.room_{{ trigger.entity_id.split('.')[1].split('_')[1] }}_ac"

- id: presence_lights
  alias: "Παρουσία → Φωτισμός"
  description: "Ενεργοποίηση φώτων με ανίχνευση παρουσίας (simulated via room status change)"
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - input_select.room_101_status
        - input_select.room_102_status
        - input_select.room_103_status
        - input_select.room_104_status
        - input_select.room_105_status
        - input_select.room_201_status
        - input_select.room_202_status
        - input_select.room_203_status
        - input_select.room_301_status
        - input_select.room_302_status
      to: "Occupied"
  action:
    - service: light.turn_on
      target:
        entity_id: "light.room_{{ trigger.entity_id.split('.')[1].split('_')[1] }}_ceiling"
      data:
        brightness_pct: 80

- id: checkin_prep
  alias: "Προετοιμασία Δωματίου"
  description: "Welcome Scene 30 λεπτά πριν το check-in (simulated with status → Preparing)"
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - input_select.room_101_status
        - input_select.room_102_status
        - input_select.room_103_status
        - input_select.room_104_status
        - input_select.room_105_status
        - input_select.room_201_status
        - input_select.room_202_status
        - input_select.room_203_status
        - input_select.room_301_status
        - input_select.room_302_status
      to: "Preparing"
  action:
    - service: climate.set_temperature
      target:
        entity_id: "climate.room_{{ trigger.entity_id.split('.')[1].split('_')[1] }}_ac"
      data:
        temperature: 24
        hvac_mode: cool
    - service: light.turn_on
      target:
        entity_id: "light.room_{{ trigger.entity_id.split('.')[1].split('_')[1] }}_ambient"
      data:
        brightness_pct: 40

- id: energy_save_ac
  alias: "Εξοικονόμηση AC"
  description: "Απενεργοποίηση AC μετά από 15 λεπτά απουσίας (simulated via status → Vacant)"
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - input_select.room_101_status
        - input_select.room_102_status
        - input_select.room_103_status
        - input_select.room_104_status
        - input_select.room_105_status
        - input_select.room_201_status
        - input_select.room_202_status
        - input_select.room_203_status
        - input_select.room_301_status
        - input_select.room_302_status
      to: "Vacant"
      for:
        minutes: 15
  action:
    - service: climate.turn_off
      target:
        entity_id: "climate.room_{{ trigger.entity_id.split('.')[1].split('_')[1] }}_ac"

# ── Ηλιακός 1: Auto ON / OFF / Sim ──────────────────────────

- id: solar_heater_1_auto_on
  alias: "Ηλιακός 1 - Αντίσταση ON"
  description: "Ενεργοποίηση αντίστασης όταν θερμοκρασία < ελάχιστο όριο"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.solar_heater_1_temperature
      below: input_number.solar_heater_1_min
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.solar_heater_1_element

- id: solar_heater_1_auto_off
  alias: "Ηλιακός 1 - Αντίσταση OFF"
  description: "Απενεργοποίηση αντίστασης όταν θερμοκρασία >= μέγιστο όριο"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.solar_heater_1_temperature
      above: input_number.solar_heater_1_max
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.solar_heater_1_element

- id: solar_heater_1_sim_heating
  alias: "Ηλιακός 1 - Προσομοίωση Θέρμανσης"
  description: "Αύξηση θερμοκρασίας +1°C / 4s όταν αντίσταση ON"
  mode: restart
  trigger:
    - platform: state
      entity_id: switch.solar_heater_1_element
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: switch.solar_heater_1_element
            state: "on"
        sequence:
          - delay:
              seconds: 4
          - service: input_number.set_value
            target:
              entity_id: input_number.solar_heater_1_temp_sim
            data:
              value: >
                {{ [states('input_number.solar_heater_1_temp_sim') | float + 1, 95] | min }}

# ── Ηλιακός 2: Auto ON / OFF / Sim ──────────────────────────

- id: solar_heater_2_auto_on
  alias: "Ηλιακός 2 - Αντίσταση ON"
  description: "Ενεργοποίηση αντίστασης όταν θερμοκρασία < ελάχιστο όριο"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.solar_heater_2_temperature
      below: input_number.solar_heater_2_min
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.solar_heater_2_element

- id: solar_heater_2_auto_off
  alias: "Ηλιακός 2 - Αντίσταση OFF"
  description: "Απενεργοποίηση αντίστασης όταν θερμοκρασία >= μέγιστο όριο"
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.solar_heater_2_temperature
      above: input_number.solar_heater_2_max
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.solar_heater_2_element

- id: solar_heater_2_sim_heating
  alias: "Ηλιακός 2 - Προσομοίωση Θέρμανσης"
  description: "Αύξηση θερμοκρασίας +1°C / 4s όταν αντίσταση ON"
  mode: restart
  trigger:
    - platform: state
      entity_id: switch.solar_heater_2_element
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: switch.solar_heater_2_element
            state: "on"
        sequence:
          - delay:
              seconds: 4
          - service: input_number.set_value
            target:
              entity_id: input_number.solar_heater_2_temp_sim
            data:
              value: >
                {{ [states('input_number.solar_heater_2_temp_sim') | float + 1, 95] | min }}

- id: night_mode
  alias: "Νυκτερινή Λειτουργία"
  description: "Μείωση κατανάλωσης μετά τις 23:00 — dim common area lights"
  mode: single
  trigger:
    - platform: time
      at: "23:00:00"
  action:
    - service: light.turn_on
      target:
        entity_id:
          - light.room_101_ceiling
          - light.room_102_ceiling
          - light.room_103_ceiling
          - light.room_104_ceiling
          - light.room_105_ceiling
          - light.room_201_ceiling
          - light.room_202_ceiling
          - light.room_203_ceiling
          - light.room_301_ceiling
          - light.room_302_ceiling
      data:
        brightness_pct: 20

- id: boiler_auto_shutoff
  alias: "Αυτόματη Απενεργοποίηση Boiler"
  description: "Απενεργοποίηση boiler μετά από 60 λεπτά λειτουργίας"
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - switch.room_101_boiler
        - switch.room_102_boiler
        - switch.room_103_boiler
        - switch.room_104_boiler
        - switch.room_105_boiler
        - switch.room_201_boiler
        - switch.room_202_boiler
        - switch.room_203_boiler
        - switch.room_301_boiler
        - switch.room_302_boiler
      to: "on"
      for:
        minutes: 60
  action:
    - service: switch.turn_off
      target:
        entity_id: "{{ trigger.entity_id }}"
